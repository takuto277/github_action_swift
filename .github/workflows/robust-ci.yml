# å …ç‰¢ãªGitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®äº’æ›æ€§å•é¡Œã«å¯¾å¿œ

name: Robust CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œå‡ºã¨ãƒ“ãƒ«ãƒ‰
  adaptive-build:
    name: Adaptive Build
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Xcodeã®ç’°å¢ƒã‚’æº–å‚™
    - name: Setup Xcode environment
      run: |
        echo "=== Xcode Environment Info ==="
        ls -la /Applications/Xcode*.app 2>/dev/null || echo "No Xcode apps found"
        
        # æœ€æ–°ã®Xcodeã‚’é¸æŠ
        if [ -d "/Applications/Xcode.app" ]; then
          sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
          echo "Selected: /Applications/Xcode.app"
        elif [ -d "/Applications/Xcode_15.4.app" ]; then
          sudo xcode-select -switch /Applications/Xcode_15.4.app/Contents/Developer
          echo "Selected: /Applications/Xcode_15.4.app"
        fi
        
        echo "=== Selected Xcode Version ==="
        xcodebuild -version
        
        echo "=== Swift Version ==="
        swift --version
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’åé›†
    - name: Analyze project
      run: |
        echo "=== Project Analysis ==="
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±
        if [ -f "github_action_swift.xcodeproj/project.pbxproj" ]; then
          echo "Project file exists"
          head -20 github_action_swift.xcodeproj/project.pbxproj
        fi
        
        # ã‚¹ã‚­ãƒ¼ãƒ ã‚’ãƒªã‚¹ãƒˆ
        echo "=== Available Schemes ==="
        xcodebuild -project github_action_swift.xcodeproj -list || echo "Could not list schemes"
        
        # åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ãƒªã‚¹ãƒˆ
        echo "=== Available Simulators ==="
        xcrun simctl list devices available
    
    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ããƒ“ãƒ«ãƒ‰
    - name: Build with fallback
      run: |
        echo "=== Building Project ==="
        
        # ãƒ“ãƒ«ãƒ‰ç”¨ã®é–¢æ•°
        build_project() {
          local destination="$1"
          echo "Trying build with destination: $destination"
          
          xcodebuild \
            -project github_action_swift.xcodeproj \
            -scheme github_action_swift \
            -destination "$destination" \
            -configuration Debug \
            -derivedDataPath ./DerivedData \
            build
        }
        
        # è¤‡æ•°ã®ãƒ‡ã‚¹ãƒ†ã‚£ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒˆãƒ©ã‚¤
        destinations=(
          "platform=iOS Simulator,name=iPhone 15"
          "platform=iOS Simulator,name=iPhone 14"
          "platform=iOS Simulator,name=iPhone 13"
          "generic/platform=iOS Simulator"
        )
        
        build_success=false
        for dest in "${destinations[@]}"; do
          if build_project "$dest"; then
            echo "âœ… Build succeeded with: $dest"
            build_success=true
            break
          else
            echo "âŒ Build failed with: $dest"
          fi
        done
        
        if [ "$build_success" = false ]; then
          echo "ğŸš¨ All build attempts failed"
          exit 1
        fi
    
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - name: Run tests (optional)
      run: |
        echo "=== Running Tests ==="
        
        # ãƒ†ã‚¹ãƒˆç”¨ã®é–¢æ•°
        test_project() {
          local destination="$1"
          echo "Trying test with destination: $destination"
          
          xcodebuild \
            -project github_action_swift.xcodeproj \
            -scheme github_action_swift \
            -destination "$destination" \
            -configuration Debug \
            -derivedDataPath ./DerivedData \
            test
        }
        
        # è¤‡æ•°ã®ãƒ‡ã‚¹ãƒ†ã‚£ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒˆãƒ©ã‚¤
        destinations=(
          "platform=iOS Simulator,name=iPhone 15"
          "platform=iOS Simulator,name=iPhone 14"
          "platform=iOS Simulator,name=iPhone 13"
        )
        
        test_success=false
        for dest in "${destinations[@]}"; do
          if test_project "$dest"; then
            echo "âœ… Test succeeded with: $dest"
            test_success=true
            break
          else
            echo "âŒ Test failed with: $dest"
          fi
        done
        
        if [ "$test_success" = false ]; then
          echo "âš ï¸ All test attempts failed, but continuing..."
        fi
      continue-on-error: true
    
    # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ä¿å­˜
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          ./DerivedData/Build/Intermediates.noindex
          ./DerivedData/Logs
        retention-days: 3
